<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAP Enterprise Command Center | Neural Orchestrator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet">
    <style>
        /* Cyberpunk / Enterprise Dark Mode Theme */
        :root {
            --bg-dark: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --neon-blue: #3b82f6;
            --neon-purple: #8b5cf6;
            --neon-green: #10b981;
            --neon-red: #ef4444;
        }

        body {
            background-color: var(--bg-dark);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 20%);
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            /* App-like feel */
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Glassmorphism */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Scrollbars */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Animations */
        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 10px var(--neon-blue);
                opacity: 1;
            }

            50% {
                box-shadow: 0 0 20px var(--neon-blue);
                opacity: 0.7;
            }
        }

        .animate-pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        @keyframes scanline {
            0% {
                transform: translateY(-100%);
            }

            100% {
                transform: translateY(100%);
            }
        }

        .scanline::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, transparent 50%, rgba(59, 130, 246, 0.1) 51%, transparent 52%);
            background-size: 100% 4px;
            animation: scanline 6s linear infinite;
            pointer-events: none;
        }

        /* Node Graph Styles */
        .node {
            transition: all 0.3s ease;
        }

        .node.active {
            fill: var(--neon-blue);
            filter: drop-shadow(0 0 8px var(--neon-blue));
        }

        /* Data Flow Animation */
        @keyframes flow {
            to {
                stroke-dashoffset: -20;
            }
        }

        .link {
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 1;
            transition: all 0.3s;
        }

        .link.active {
            stroke: var(--neon-blue);
            stroke-width: 2;
            opacity: 1;
            filter: drop-shadow(0 0 5px var(--neon-blue));
        }

        .link.traffic {
            stroke-dasharray: 5 5;
            animation: flow 1s linear infinite;
            opacity: 0.3;
        }
    </style>
</head>

<body class="h-screen flex flex-col">

    <!-- Top Bar: Enterprise Status -->
    <header class="h-14 glass flex items-center justify-between px-6 z-50">
        <div class="flex items-center space-x-3">
            <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
            <h1
                class="text-lg font-bold tracking-wide uppercase text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">
                SAP Enterprise Command Center <span class="text-xs text-gray-500 ml-2">v5.0 [SUPERNOVA]</span>
            </h1>
        </div>
        <div class="flex items-center space-x-6 text-xs font-mono text-gray-400">
            <div class="flex items-center space-x-2">
                <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                <span>ORCHESTRATOR: ONLINE</span>
            </div>
            <div class="flex items-center space-x-2">
                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                <span>BTP CONNECTION: SECURE</span>
            </div>
            <div id="clock">00:00:00</div>
        </div>
    </header>

    <!-- Main Grid Layout -->
    <main class="flex-1 grid grid-cols-12 gap-4 p-4 overflow-hidden">

        <!-- LEFT PANE: Neural Graph (Agents) -->
        <section class="col-span-3 glass rounded-2xl flex flex-col relative overflow-hidden">
            <div class="p-4 border-b border-gray-700/50 flex justify-between items-center">
                <h2 class="text-xs font-bold uppercase tracking-wider text-blue-400">Neural Network</h2>
                <span class="text-[10px] bg-blue-500/10 text-blue-400 px-2 py-0.5 rounded">LIVE TRAFFIC</span>
            </div>
            <div class="flex-1 relative" id="neural-graph">
                <!-- SVG Graph will be injected here -->
                <svg width="100%" height="100%" viewBox="0 0 400 400" class="absolute inset-0">
                    <!-- Central Orchestrator -->
                    <circle cx="200" cy="200" r="30" fill="#1e293b" stroke="#3b82f6" stroke-width="2" class="node"
                        id="node-orchestrator" />
                    <text x="200" y="245" text-anchor="middle" fill="#94a3b8" font-size="10"
                        font-family="monospace">ORCHESTRATOR</text>

                    <!-- ARIBA (Procurement) - Top Left -->
                    <line x1="200" y1="200" x2="100" y2="100" class="link traffic" id="link-ariba" />
                    <circle cx="100" cy="100" r="20" fill="#1e293b" stroke="#64748b" stroke-width="2" class="node"
                        id="node-ariba" />
                    <text x="100" y="75" text-anchor="middle" fill="#64748b" font-size="9"
                        font-family="monospace">ARIBA</text>

                    <!-- SUCCESSFACTORS (HR) - Top Right -->
                    <line x1="200" y1="200" x2="300" y2="100" class="link traffic" id="link-successfactors" />
                    <circle cx="300" cy="100" r="20" fill="#1e293b" stroke="#64748b" stroke-width="2" class="node"
                        id="node-successfactors" />
                    <text x="300" y="75" text-anchor="middle" fill="#64748b" font-size="9"
                        font-family="monospace">SUCCESSFACTORS</text>

                    <!-- CONCUR (Travel) - Right -->
                    <line x1="200" y1="200" x2="340" y2="200" class="link traffic" id="link-concur" />
                    <circle cx="340" cy="200" r="18" fill="#1e293b" stroke="#64748b" stroke-width="2" class="node"
                        id="node-concur" />
                    <text x="340" y="235" text-anchor="middle" fill="#64748b" font-size="9"
                        font-family="monospace">CONCUR</text>

                    <!-- IBP (Planning) - Bottom Right -->
                    <line x1="200" y1="200" x2="300" y2="300" class="link traffic" id="link-ibp" />
                    <circle cx="300" cy="300" r="20" fill="#1e293b" stroke="#64748b" stroke-width="2" class="node"
                        id="node-ibp" />
                    <text x="300" y="335" text-anchor="middle" fill="#64748b" font-size="9"
                        font-family="monospace">IBP</text>

                    <!-- EWM (Warehouse) - Bottom Left -->
                    <line x1="200" y1="200" x2="100" y2="300" class="link traffic" id="link-ewm" />
                    <circle cx="100" cy="300" r="20" fill="#1e293b" stroke="#64748b" stroke-width="2" class="node"
                        id="node-ewm" />
                    <text x="100" y="335" text-anchor="middle" fill="#64748b" font-size="9"
                        font-family="monospace">EWM</text>

                    <!-- S/4HANA (Core ERP) - Left -->
                    <line x1="200" y1="200" x2="60" y2="200" class="link traffic" id="link-s4" />
                    <circle cx="60" cy="200" r="22" fill="#1e293b" stroke="#64748b" stroke-width="2" class="node"
                        id="node-s4" />
                    <text x="60" y="235" text-anchor="middle" fill="#64748b" font-size="9"
                        font-family="monospace">S/4HANA</text>
                </svg>
            </div>
            <!-- Active Agent Status -->
            <div class="p-4 border-t border-gray-700/50 h-32 font-mono text-xs overflow-y-auto" id="agent-logs">
                <div class="text-gray-500">> System Initialized...</div>
                <div class="text-gray-500">> Neural Graph Active.</div>
                <div class="text-gray-500">> Monitoring 6 SAP Nodes...</div>
            </div>
        </section>

        <!-- CENTER PANE: Command Stream (Chat + CoT) -->
        <section class="col-span-6 flex flex-col gap-4">
            <!-- Thought Stream (The "Brain") -->
            <div class="h-1/3 glass rounded-2xl flex flex-col overflow-hidden scanline">
                <div class="p-3 border-b border-gray-700/50 bg-black/20 flex justify-between">
                    <h2 class="text-xs font-bold uppercase tracking-wider text-purple-400">Thought Stream
                        (Chain-of-Thought)</h2>
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 rounded-full bg-red-500"></div>
                        <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                    </div>
                </div>
                <div class="flex-1 p-4 font-mono text-xs text-green-400 overflow-y-auto" id="thought-stream">
                    <!-- Streaming logs go here -->
                    <div class="opacity-50">_ awaiting_neural_input...</div>
                </div>
            </div>

            <!-- Interaction Interface (Chat) -->
            <div class="flex-1 glass rounded-2xl flex flex-col overflow-hidden">
                <div class="flex-1 p-6 overflow-y-auto space-y-6" id="chat-history">
                    <!-- Messages -->
                    <div class="flex items-start space-x-4">
                        <div class="w-8 h-8 rounded bg-blue-600 flex items-center justify-center text-xs font-bold">AI
                        </div>
                        <div class="bg-gray-800/50 p-4 rounded-lg text-sm max-w-xl border border-gray-700">
                            System Online. I am ready to orchestrate your Extended SAP Enterprise.
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-4 bg-gray-900/50 border-t border-gray-700/50">
                    <div class="relative">
                        <input type="text" id="user-input"
                            class="w-full bg-gray-800/50 border border-gray-600 rounded-xl px-4 py-4 pr-12 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition font-mono"
                            placeholder="Enter command or query..." autocomplete="off">
                        <button onclick="sendMessage()"
                            class="absolute right-2 top-2 p-2 text-blue-400 hover:text-white transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                    <!-- Quick Actions -->
                    <div class="mt-4 flex justify-center">
                        <button onclick="runTitanSequence()"
                            class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform transition hover:scale-[1.02] flex items-center justify-center space-x-3 border border-white/10">
                            <svg class="w-6 h-6 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            <span class="tracking-wide">‚ñ∂ DEMO: WITNESS THE POWER OF A PROMPT</span>
                        </button>
                    </div>
                    <!-- Scenario Legend -->
                    <div class="mt-3 px-4 py-2 bg-blue-900/20 rounded-lg border border-blue-500/30">
                        <div class="text-[10px] uppercase tracking-widest text-blue-400 font-bold mb-1">Autonomous Chain
                            Reaction:</div>
                        <div class="flex justify-between text-[10px] text-gray-400 font-mono">
                            <span>1. Sales Won</span>
                            <span>‚Üí</span>
                            <span>2. Capacity Check</span>
                            <span>‚Üí</span>
                            <span>3. Material Shortage</span>
                            <span>‚Üí</span>
                            <span class="text-red-400">4. Auto-Sourcing</span>
                            <span>‚Üí</span>
                            <span>5. Auto-Hiring</span>
                            <span>‚Üí</span>
                            <span class="text-green-400">6. Profit Approval</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- RIGHT PANE: Live Telemetry -->
        <section class="col-span-3 flex flex-col gap-4">
            <!-- Widget 1: EHS -->
            <div class="glass p-4 rounded-2xl">
                <h3 class="text-xs font-bold uppercase text-gray-400 mb-2">Enterprise Health Score</h3>
                <div class="flex items-end justify-between">
                    <div class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400"
                        id="ehs-score">--</div>
                    <div class="text-xs text-green-400 mb-1">‚ñ≤ 2.4%</div>
                </div>
                <div class="mt-2 h-1 bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-purple-500 to-pink-500 w-0 transition-all duration-1000"
                        id="ehs-bar"></div>
                </div>
                <div class="mt-3 grid grid-cols-2 gap-2 text-[10px] font-mono text-gray-500">
                    <div>PERF: <span class="text-white" id="ehs-p">--</span></div>
                    <div>RISK: <span class="text-red-400" id="ehs-r">--</span></div>
                </div>
            </div>

            <!-- Widget 2: BTP Health -->
            <div class="glass p-4 rounded-2xl flex-1">
                <h3 class="text-xs font-bold uppercase text-gray-400 mb-4">SAP BTP Telemetry</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-400">Success Rate</span>
                            <span class="text-green-400 font-mono" id="btp-success">--%</span>
                        </div>
                        <div class="h-1 bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-green-500 w-0 transition-all duration-1000" id="btp-success-bar">
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-400">Response Latency</span>
                            <span class="text-blue-400 font-mono" id="btp-latency">--ms</span>
                        </div>
                        <div class="h-1 bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-500 w-0 transition-all duration-1000" id="btp-latency-bar"></div>
                        </div>
                    </div>
                    <div class="p-3 bg-gray-800/50 rounded border border-gray-700 mt-4">
                        <div class="text-[10px] text-gray-500 uppercase">Active Connection</div>
                        <div class="text-xs font-mono text-white truncate mt-1">Cloudflare Tunnel: SECURE</div>
                        <div class="text-[10px] text-green-500 mt-1">‚óè Live Data Stream</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // --- CONFIGURATION ---
        const API_BASE = 'http://localhost:8000';

        // --- DOM ELEMENTS ---
        const userInput = document.getElementById('user-input');
        const chatHistory = document.getElementById('chat-history');
        const thoughtStream = document.getElementById('thought-stream');
        const agentLogs = document.getElementById('agent-logs');

        // --- CLOCK ---
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        }, 1000);

        // --- NEURAL GRAPH LOGIC ---
        function activateNode(agentName) {
            // Reset all
            document.querySelectorAll('.node').forEach(n => {
                n.setAttribute('fill', '#1e293b');
                n.setAttribute('stroke', '#64748b');
                n.classList.remove('active');
            });
            document.querySelectorAll('.link').forEach(l => l.classList.remove('active'));

            // Map agent name to ID
            let nodeId = '';
            const name = agentName.toLowerCase();

            if (name.includes('procurement') || name.includes('ariba')) nodeId = 'ariba';
            else if (name.includes('knowledge') || name.includes('hr') || name.includes('successfactors')) nodeId = 'successfactors';
            else if (name.includes('travel') || name.includes('expense') || name.includes('concur')) nodeId = 'concur';
            else if (name.includes('warehouse') || name.includes('ewm') || name.includes('inventory')) nodeId = 'ewm';
            else if (name.includes('planning') || name.includes('ibp') || name.includes('forecast')) nodeId = 'ibp';
            else if (name.includes('finance') || name.includes('s/4') || name.includes('erp')) nodeId = 's4';
            else if (name.includes('analytics')) nodeId = 'ibp'; // Analytics often relates to planning

            // Activate Orchestrator + Target
            const orch = document.getElementById('node-orchestrator');
            orch.setAttribute('fill', '#3b82f6');
            orch.classList.add('active');

            if (nodeId) {
                const target = document.getElementById(`node-${nodeId}`);
                const link = document.getElementById(`link-${nodeId}`);
                if (target && link) {
                    target.setAttribute('fill', '#3b82f6');
                    target.setAttribute('stroke', '#fff');
                    target.classList.add('active');
                    link.classList.add('active');

                    // Log it
                    const log = document.createElement('div');
                    log.className = 'text-blue-400';
                    log.innerText = `> ACTIVATING NODE: ${nodeId.toUpperCase()}`;
                    agentLogs.prepend(log);
                }
            }
        }

        // --- THOUGHT STREAM LOGIC ---
        async function streamThoughts(trace) {
            thoughtStream.innerHTML = ''; // Clear previous

            for (const step of trace) {
                const line = document.createElement('div');
                line.className = 'mb-1 border-l-2 border-gray-700 pl-2';

                const timestamp = step.timestamp.split('T')[1].split('.')[0];
                const content = `[${timestamp}] <span class="text-purple-300 font-bold">${step.step}</span>: ${JSON.stringify(step.details)}`;

                line.innerHTML = content;
                thoughtStream.appendChild(line);
                thoughtStream.scrollTop = thoughtStream.scrollHeight;

                // Simulate "thinking" time
                await new Promise(r => setTimeout(r, 600));
            }

            const done = document.createElement('div');
            done.className = 'text-green-400 font-bold mt-2';
            done.innerText = '>> EXECUTION COMPLETE';
            thoughtStream.appendChild(done);
        }

        // --- CHAT LOGIC ---
        function triggerAgent(query) {
            userInput.value = query;
            sendMessage();
        }

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // --- DEMO MODE: Project Titan (Client-Side Simulation) ---
        async function simulateTitanDemo() {
            const stream = document.getElementById('thought-stream');
            const logs = document.getElementById('agent-logs');
            const graph = document.getElementById('neural-graph');

            function log(agent, message, color = 'text-green-400') {
                const div = document.createElement('div');
                div.className = `mb-1 ${color}`;
                div.innerHTML = `<span class="font-bold">[${agent}]</span> ${message}`;
                stream.appendChild(div);
                stream.scrollTop = stream.scrollHeight;
            }

            function activate(nodeId) {
                document.querySelectorAll('.node').forEach(n => {
                    n.setAttribute('fill', '#1e293b');
                    n.setAttribute('stroke', '#64748b');
                    n.classList.remove('active');
                    n.removeAttribute('filter'); // Remove filter for glow
                });
                document.querySelectorAll('.link').forEach(l => l.classList.remove('active'));

                const node = document.getElementById('node-' + nodeId);
                if (node) {
                    node.setAttribute('fill', '#3b82f6');
                    node.setAttribute('stroke', '#fff'); // Ensure stroke is white for active
                    node.classList.add('active');
                    node.setAttribute('filter', 'drop-shadow(0 0 10px #3b82f6)');
                }

                // Activate link to orchestrator
                const link = document.getElementById('link-' + nodeId);
                if (link) link.classList.add('active');

                // Log it to agentLogs
                const logDiv = document.createElement('div');
                logDiv.className = 'text-blue-400';
                logDiv.innerText = `> ACTIVATING NODE: ${nodeId.toUpperCase()}`;
                logs.prepend(logDiv);
            }

            // Clear previous states
            thoughtStream.innerHTML = '';
            agentLogs.innerHTML = '';
            document.querySelectorAll('.node').forEach(n => {
                n.setAttribute('fill', '#1e293b');
                n.setAttribute('stroke', '#64748b');
                n.classList.remove('active');
                n.removeAttribute('filter');
            });
            document.querySelectorAll('.link').forEach(l => l.classList.remove('active'));

            // Start
            log('SYSTEM', 'Initializing Project Titan Protocol...', 'text-blue-400');
            appendMessage('AI', 'Initiating Project Titan simulation. Please observe the thought stream and neural graph.', 'ai');
            await new Promise(r => setTimeout(r, 1000));

            // 1. Sales
            activate('orchestrator');
            log('SALES', 'WON DEAL: Tesla (50,000 Units). Revenue: $50M.');
            appendMessage('AI', 'Sales Agent reports a new strategic deal with Tesla. Initiating fulfillment chain.');
            await new Promise(r => setTimeout(r, 1500));

            // 2. Manufacturing
            activate('s4'); // S/4HANA for Mfg
            log('MANUFACTURING', 'CRITICAL: Capacity Shortfall (10k units). Required by Q4.', 'text-red-400');
            await new Promise(r => setTimeout(r, 1500));

            // 3. Supply Chain
            activate('ibp');
            log('SUPPLY_CHAIN', 'ALERT: Low Inventory (Aluminum). Need 50 tons.', 'text-yellow-400');
            await new Promise(r => setTimeout(r, 1500));

            // 4. Procurement (Failure)
            activate('ariba');
            log('PROCUREMENT', '‚ö†Ô∏è ERROR: Primary Supplier (Alcoa) OUT OF STOCK.', 'text-red-500');
            await new Promise(r => setTimeout(r, 1000));

            // 4b. Recovery
            log('ORCHESTRATOR', 'üîÑ SELF-HEALING: Initiating Global Sourcing Search...', 'text-purple-400');
            await new Promise(r => setTimeout(r, 1500));
            log('PROCUREMENT', '‚úÖ RECOVERY: Sourced from Rio Tinto (Mexico). +8% Cost. FASTER DELIVERY.', 'text-green-400');
            await new Promise(r => setTimeout(r, 1500));

            // 5. HR
            activate('successfactors');
            log('HR', 'RECRUITING: Posted 50 "Assembly Tech" Reqs to meet capacity.', 'text-blue-300');
            await new Promise(r => setTimeout(r, 1500));

            // 6. Finance
            activate('s4');
            log('FINANCE', 'ANALYSIS: Margin impact -1.5%. Net Profit $8.2M. APPROVED.', 'text-green-500');
            await new Promise(r => setTimeout(r, 1000));

            appendMessage('AI', 'Project Titan execution complete. Supply chain failure healed. Production scheduled. Net Profit: $8.2M.');
            log('SYSTEM', '>> SIMULATION COMPLETE', 'text-green-400 font-bold');
            fetchMetrics(); // Refresh metrics after simulation
        }

        // --- UNIVERSAL CLIENT-SIDE HANDLER ---
        async function handleLocalPrompt(prompt) {
            const p = prompt.toLowerCase();

            // 1. Project Titan Trigger
            if (p.includes('titan') || p.includes('tesla')) {
                await simulateTitanDemo();
                return;
            }

            // 2. Keyword Routing & Simulation
            let agent = 'ORCHESTRATOR';
            let response = "I'm processing your request...";
            let nodeId = 'orchestrator';
            let color = 'text-blue-400';

            if (p.includes('inventory') || p.includes('stock') || p.includes('ewm') || p.includes('warehouse')) {
                agent = 'EWM_AGENT';
                nodeId = 'ewm';
                response = "Checking Warehouse Levels... <br>‚Ä¢ **Material M-100**: 450 units (Low)<br>‚Ä¢ **Material X-99**: 1,200 units (Optimal)<br>‚Ä¢ **Location**: Walldorf DC";
                color = 'text-yellow-400';
            }
            else if (p.includes('hire') || p.includes('candidate') || p.includes('successfactors') || p.includes('hr')) {
                agent = 'HR_AGENT';
                nodeId = 'successfactors';
                response = "Accessing SuccessFactors Recruiting...<br>‚Ä¢ **Open Reqs**: 12<br>‚Ä¢ **New Applicants**: 45 (Last 24h)<br>‚Ä¢ **Top Candidate**: Sarah J. (98% Match for Senior Dev)";
                color = 'text-pink-400';
            }
            else if (p.includes('budget') || p.includes('finance') || p.includes('cost') || p.includes('margin') || p.includes('s/4')) {
                agent = 'FINANCE_AGENT';
                nodeId = 's4';
                response = "Querying S/4HANA Finance...<br>‚Ä¢ **Q4 Budget Utilization**: 78%<br>‚Ä¢ **Current Margin**: 22.4% (+1.2% YoY)<br>‚Ä¢ **Cash Flow**: Positive";
                color = 'text-green-400';
            }
            else if (p.includes('supplier') || p.includes('ariba') || p.includes('procurement') || p.includes('source')) {
                agent = 'PROCUREMENT_AGENT';
                nodeId = 'ariba';
                response = "Scanning Ariba Network...<br>‚Ä¢ **Active RFPs**: 3<br>‚Ä¢ **Supplier Health**: 98% (Low Risk)<br>‚Ä¢ **Pending Approval**: PO #4500012345 ($12,500)";
                color = 'text-blue-300';
            }
            else if (p.includes('travel') || p.includes('concur') || p.includes('flight') || p.includes('expense')) {
                agent = 'CONCUR_AGENT';
                nodeId = 'concur';
                response = "Checking Concur Travel...<br>‚Ä¢ **Next Trip**: SAP TechEd (Berlin)<br>‚Ä¢ **Flight**: LH404 (Confirmed)<br>‚Ä¢ **Pending Expenses**: $450.00 (Needs Approval)";
                color = 'text-teal-400';
            }
            else if (p.includes('plan') || p.includes('ibp') || p.includes('forecast') || p.includes('supply chain')) {
                agent = 'IBP_AGENT';
                nodeId = 'ibp';
                response = "Running IBP Simulation...<br>‚Ä¢ **Demand Forecast**: +15% (Q1 2026)<br>‚Ä¢ **Supply Gap**: None identified.<br>‚Ä¢ **Risk Score**: Low";
                color = 'text-purple-400';
            }
            else {
                // Fallback to generic orchestrator response
                response = "I have received your query. Orchestrating relevant SAP agents to assist you.";
            }

            // Execute Simulation
            appendMessage('User', prompt); // Use appendMessage for user input

            // Thought Stream
            const stream = document.getElementById('thought-stream');
            const logs = document.getElementById('agent-logs');

            // 1. Orchestrator Thinking
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'mb-1 text-gray-400 animate-pulse';
            thinkingDiv.innerHTML = `<span class="font-bold">[ORCHESTRATOR]</span> Analyzing intent: "${prompt}"...`;
            stream.appendChild(thinkingDiv);
            stream.scrollTop = stream.scrollHeight;
            await new Promise(r => setTimeout(r, 800));

            // 2. Activate Node
            activateNodeLocal(nodeId); // Use the local helper activateNode

            // 3. Agent Log
            const logDiv = document.createElement('div');
            logDiv.className = `mb-1 ${color}`;
            logDiv.innerHTML = `<span class="font-bold">[${agent}]</span> Executing query...`;
            stream.appendChild(logDiv);
            stream.scrollTop = stream.scrollHeight;

            const sysLog = document.createElement('div');
            sysLog.className = 'text-blue-400';
            sysLog.innerText = `> AGENT ACTIVE: ${agent}`;
            logs.prepend(sysLog);

            await new Promise(r => setTimeout(r, 1000));

            // 4. Response
            stream.removeChild(thinkingDiv);
            appendMessage('AI', response); // Use appendMessage for AI response
        }

        // Helper for node activation (reused from Demo Mode)
        function activateNodeLocal(nodeId) { // Renamed to avoid conflict with global activateNode
            document.querySelectorAll('.node').forEach(n => {
                n.setAttribute('fill', '#1e293b');
                n.setAttribute('stroke', '#64748b');
                n.classList.remove('active');
                n.removeAttribute('filter');
            });
            document.querySelectorAll('.link').forEach(l => l.classList.remove('active'));

            const node = document.getElementById('node-' + nodeId);
            if (node) {
                node.setAttribute('fill', '#3b82f6');
                node.setAttribute('stroke', '#fff');
                node.classList.add('active');
                node.setAttribute('filter', 'drop-shadow(0 0 10px #3b82f6)');
            }

            const link = document.getElementById('link-' + nodeId);
            if (link) link.classList.add('active');
        }

        async function triggerAgent(prompt) {
            // Use local handler for everything in this demo version
            await handleLocalPrompt(prompt);
        }

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // --- TYPEWRITER EFFECT ---
        async function typeWriter(text) {
            userInput.value = '';
            userInput.focus();
            for (let i = 0; i < text.length; i++) {
                userInput.value += text.charAt(i);
                await new Promise(r => setTimeout(r, 50)); // Typing speed
            }
            await new Promise(r => setTimeout(r, 500)); // Pause before submit
        }

        async function runTitanSequence() {
            // 1. Type the powerful prompt
            await typeWriter("Execute Strategic Growth Plan: Project Titan");

            // 2. Submit it (Triggering the Universal Handler)
            await handleLocalPrompt(userInput.value);
            userInput.value = '';
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;
            userInput.value = '';
            await handleLocalPrompt(text);
        }

        // The original sendMessage logic (API call) is now effectively bypassed by handleLocalPrompt.
        // If you wanted to keep the API call as a fallback, you would modify handleLocalPrompt
        // to return a boolean indicating if it handled the prompt, and then sendMessage would
        // proceed with the API call if handleLocalPrompt returned false.
        /*
        async function sendMessageOriginal() { // Renamed original sendMessage for reference
            const text = userInput.value.trim();
            if (!text) return;

            // User Msg
            appendMessage('User', text, 'user');
            userInput.value = '';

            // AI Loading
            const loadingId = appendMessage('AI', 'Analyzing request...', 'ai', true);

            // Activate Orchestrator Visual
            activateNode('Orchestrator'); // This uses the global activateNode
            thoughtStream.innerHTML = '<div class="animate-pulse">> Ingesting query...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                const data = await response.json();

                // Remove loading
                document.getElementById(loadingId).remove();

                // 1. Visualize the Trace (Thought Stream)
                if (data.trace) {
                    // Determine active agent from trace
                    const planStep = data.trace.find(s => s.step === 'Plan Generated');
                    if (planStep && planStep.details.strategy.details.agent) {
                        activateNode(planStep.details.strategy.details.agent);
                    }
                    // Stream thoughts
                    streamThoughts(data.trace);
                }

                // 2. Show Response
                const aiText = typeof data.response === 'object' ? data.response.response : data.response;
                appendMessage('AI', aiText, 'ai');

                // 3. Refresh Metrics
                fetchMetrics();

            } catch (error) {
                document.getElementById(loadingId).remove();
                appendMessage('AI', 'CRITICAL ERROR: Connection Lost.', 'ai');
                thoughtStream.innerHTML += '<div class="text-red-500">>> CONNECTION FAILED</div>';
            }
        }

        function appendMessage(sender, text, type, isLoading = false) {
            const id = 'msg-' + Date.now();
            const align = type === 'user' ? 'justify-end' : 'justify-start';
            const bg = type === 'user' ? 'bg-blue-600/20 border border-blue-500/30 text-blue-100' : 'bg-gray-800/50 border border-gray-700 text-gray-300';

            const content = type === 'ai' ? marked.parse(text) : text;

            const html = `
                <div id="${id}" class="flex items-start ${align} animate-fade-in">
                    ${type === 'ai' ? '<div class="w-6 h-6 rounded bg-blue-600 flex items-center justify-center text-[10px] mr-3 mt-1">AI</div>' : ''}
                    <div class="${bg} p-3 rounded-xl max-w-lg text-sm ${isLoading ? 'animate-pulse' : ''} prose prose-invert">
                        ${content}
                    </div>
                </div>
            `;
            chatHistory.insertAdjacentHTML('beforeend', html);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return id;
        }

        // --- METRICS POLLING ---
        async function fetchMetrics() {
            try {
                // 1. EHS
                const resFormula = await fetch(`${API_BASE}/api/formula`);
                const dataFormula = await resFormula.json();

                document.getElementById('ehs-score').innerText = dataFormula.score;
                document.getElementById('ehs-bar').style.width = `${dataFormula.score}%`;
                document.getElementById('ehs-p').innerText = dataFormula.components.performance.value;
                document.getElementById('ehs-r').innerText = dataFormula.components.risk.value;

                // 2. BTP Health
                const resHealth = await fetch(`${API_BASE}/api/health`);
                const dataHealth = await resHealth.json();

                document.getElementById('btp-success').innerText = `${dataHealth.system.success_rate}%`;
                document.getElementById('btp-success-bar').style.width = `${dataHealth.system.success_rate}%`;

                // Parse latency string "0.80s" -> 800ms
                const latencySec = parseFloat(dataHealth.system.avg_response_time.replace('s', ''));
                const latencyMs = Math.round(latencySec * 1000);
                document.getElementById('btp-latency').innerText = `${latencyMs}ms`;

                // Visual bar for latency (inverse scale, lower is better)
                const latencyPercent = Math.min(100, (latencyMs / 2000) * 100);
                document.getElementById('btp-latency-bar').style.width = `${latencyPercent}%`;

            } catch (e) {
                console.error("Telemetry Error", e);
            }
        }

        // Init
        fetchMetrics();
        setInterval(fetchMetrics, 10000);

    </script>
</body>

</html>